<script src="../quill/quill.js"></script>
<link rel="import" href="../polymer/polymer.html">
<!--
  `<quill-browser></quill-browser>` n
  @demo demo.html
-->
<dom-module id="quill-browser">
  <template>
    <style>
      :host {
        display:block;
      }
      #editor {
        height: 375px;
      }
    </style>
    <template is="dom-if" if="[[theme]]">
      <link href$="../quill/quill.[[theme]].css" rel="stylesheet">
    </template>
    <div id="editor"><content></content></div>
  </template>
</dom-module>
<script>
  Polymer({
    is: "quill-browser",
      properties:{
      toolbar:{
        value: [
          [{ header: [1, 2, 3, false] }],
          ['bold', 'italic', 'underline'],
          ['image', 'code-block']
        ],
      },
      placeholder: {
        value: "Compose an epic..."
      },
      theme: {
        value: "snow" // or 'bubble'
      },
      _getReady: {
        computed: "getReady(toolbar,placeholder,theme)"
      },
      saveInterval: {
        type: Number,
        value: 2000,
      },
      value:{
        type:Object,
        notify:true,
      },
    },
    getReady: function(toolbar,placeholder,theme){
      var editor = new Quill(this.$.editor,{
        modules: {
          toolbar: toolbar
        },
        placeholder: placeholder,
        theme: theme
      })
      var change = 0
      var typingTimer
      var saveInterval = this.saveInterval
      var source = "api"
      var savePeriodically = function(delta) {
        if (change > 0) {
          if (this.showResults) {
            console.log('Saving changes', change)
          }
          this.content = editor.getContents()
          // Fire custom event change
          if (source == "user") {
            this.fire('change', {delta: change, content: this.content})
          } else {
            this.fire('update', {delta: change, content: this.content})
          }
          change = 0
          this.value = this.content
          
        } else if (JSON.stringify(this.content) !== JSON.stringify(editor.getContents())) { // Allow changes from the Two-way   data binding system
          this.resetContent(this.content)
        }
        clearTimeout(typingTimer)
        typingTimer = setTimeout(savePeriodically, saveInterval)
      }.bind(this)
      editor.on('text-change', function(delta, oldDelta, theSource) {
        change = 1
        source = theSource
        clearTimeout(typingTimer)
        typingTimer = setTimeout(savePeriodically, saveInterval)
      })
      // Check for unsaved data
      window.onbeforeunload = function() {
        if (change > 0) {
          return 'There are unsaved changes. Are you sure you want to leave?'
        }
      }
    },
    
  })
</script>
